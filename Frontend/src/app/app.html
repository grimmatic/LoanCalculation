<div class="page">
  <!-- Navigation Tabs -->
  <div class="nav">
    <div class="container nav__inner">
      <img src="favicon.png" alt="Kredi Hesaplama" class="nav__logo">
      <button (click)="setActiveTab('hesaplama')" 
              class="nav__tab"
              [class.nav__tab--active]="activeTab === 'hesaplama'">
        Kredi Hesaplama
      </button>
      <button (click)="setActiveTab('basvuru')" 
              class="nav__tab"
              [class.nav__tab--active]="activeTab === 'basvuru'">
        Kredi Başvuru
      </button>
      <button *ngIf="!isLoggedIn" (click)="setActiveTab('auth')" 
              class="nav__tab"
              [class.nav__tab--active]="activeTab === 'auth'">
        Giriş/Kayıt
      </button>
      <button *ngIf="isLoggedIn" (click)="setActiveTab('banka-uyelik')" 
              class="nav__tab"
              [class.nav__tab--active]="activeTab === 'banka-uyelik'">
        Banka Müşterisi Ol
      </button>
      <div *ngIf="isLoggedIn" class="nav__user">
        <span class="nav__user-email">{{currentUser?.email}}</span>
        <button (click)="logout()" class="btn btn--small btn--outline">Çıkış</button>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- Kredi Hesaplama Tab -->
    <div *ngIf="activeTab === 'hesaplama'" class="container">
      <h1 class="title">Kredi Hesaplama</h1>
      
      <div class="grid-2">
        <!-- Sol Panel - Form -->
        <div class="card">
          <h2 class="card__title">Kredi Bilgileri</h2>
          
          <!-- Hesaplama Modu Seçimi -->
          <div class="section">
            <label class="label">Hesaplama Modu</label>
            <div class="row-gap">
              <label class="radio">
                <input type="radio" 
                       name="hesaplamaModu" 
                       value="urun"
                       [(ngModel)]="hesaplamaModu"
                       (change)="onHesaplamaModuChange()">
                <span>Banka Ürünü Seç</span>
              </label>
              <label class="radio">
                <input type="radio" 
                       name="hesaplamaModu" 
                       value="manuel"
                       [(ngModel)]="hesaplamaModu"
                       (change)="onHesaplamaModuChange()">
                <span>Manuel Faiz Gir</span>
              </label>
            </div>
          </div>

          <!-- Ürün Bazlı Hesaplama -->
          <div *ngIf="hesaplamaModu === 'urun'">
            <div class="form-group">
              <label class="label">Banka</label>
              <select [(ngModel)]="selectedBankaId" 
                      (ngModelChange)="onBankaChange()"
                      class="input">
                <option value="">Banka Seçiniz</option>
                <option *ngFor="let banka of bankalar" [value]="banka.id">{{banka.ad}}</option>
              </select>
            </div>

            <div class="form-group">
              <label class="label">Kredi Ürünü</label>
              <select [(ngModel)]="selectedBankaUrunId" 
                      (ngModelChange)="onBankaUrunChange()"
                      [disabled]="!selectedBankaId"
                      class="input"
                      [class.input--disabled]="!selectedBankaId">
                <option value="">Ürün Seçiniz</option>
                <option *ngFor="let urun of bankaUrunleri" [value]="urun.id">
                  {{urun.urunAdi}} - Faiz: %{{urun.faizOrani}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label class="label">Kredi Tutarı (₺)</label>
              <input type="number" 
                     [(ngModel)]="krediTutari"
                     class="input"
                     placeholder="Örn: 100000">
              <div *ngIf="selectedBankaUrunu" class="hint">
                Min: {{selectedBankaUrunu.minTutar | number:'1.0-0'}} ₺ - Max: {{selectedBankaUrunu.maxTutar | number:'1.0-0'}} ₺
              </div>
            </div>

            <div class="form-group">
              <label class="label">Vade (Ay)</label>
              <input type="number" 
                     [(ngModel)]="krediVadesi"
                     class="input"
                     placeholder="Örn: 36">
              <div *ngIf="selectedBankaUrunu" class="hint">
                Min: {{selectedBankaUrunu.minVade}} ay - Max: {{selectedBankaUrunu.maxVade}} ay
              </div>
            </div>
          </div>

          <!-- Manuel Faiz Girişi -->
          <div *ngIf="hesaplamaModu === 'manuel'">
            <div class="form-group">
              <label class="label">Kredi Tutarı (₺)</label>
              <input type="number" 
                     [(ngModel)]="krediTutari"
                     class="input"
                     placeholder="Örn: 100000">
            </div>

            <div class="form-group">
              <label class="label">Vade (Ay)</label>
              <input type="number" 
                     [(ngModel)]="krediVadesi"
                     class="input"
                     placeholder="Örn: 36">
            </div>

            <div class="form-group">
              <label class="label">Aylık Faiz Oranı (%)</label>
              <input type="number" 
                     [(ngModel)]="manuelFaizOrani"
                     step="0.01"
                     class="input"
                     placeholder="Örn: 3.50">
              <div class="hint">
                Aylık faiz oranını girin (örn: %3.50 için 3.50 yazın)
              </div>
            </div>
          </div>

          <button (click)="hesapla()" 
                  [disabled]="!canCalculate()"
                  class="btn btn--primary btn--block"
                  [class.btn--disabled]="!canCalculate()">
            Hesapla
          </button>
        </div>

        <!-- Sağ Panel - Sonuçlar -->
       <div *ngIf="hesaplamaResult" class="card">
          <h2 class="card__title">Hesaplama Sonucu</h2>
          
          <div class="box"> 
            <!-- Seçilen Banka ve Ürün Bilgisi -->
            <div *ngIf="selectedBankaUrunu" class="summary">
              <div class="summary__row">
                <span class="muted">Banka:</span>
                <span class="bold">{{selectedBankaUrunu.bankaAdi}}</span>
              </div>
              <div class="summary__row">
                <span class="muted">Ürün:</span>
                <span class="bold">{{selectedBankaUrunu.urunAdi}}</span>
              </div>
            </div>

            <div class="grid-2 text-sm">
              <div>
                <span class="muted">Kredi Tutarı:</span>
                <div class="bold">{{hesaplamaResult.ozet.krediTutari | number:'1.2-2'}} ₺</div>
              </div>
              <div>
                <span class="muted">Vade:</span>
                <div class="bold">{{hesaplamaResult.ozet.vade}} ay</div>
              </div>
              <div>
                <span class="muted">Faiz Oranı:</span>
                <div class="bold">%{{hesaplamaResult.ozet.faizOrani}}</div>
              </div>
              <div>
                <span class="muted">Aylık Ödeme:</span>
                <div class="bold text-primary">{{hesaplamaResult.ozet.aylikOdeme | number:'1.2-2'}} ₺</div>
              </div>
              <div>
                <span class="muted">Toplam Ödeme:</span>
                <div class="bold">{{hesaplamaResult.ozet.toplamOdeme | number:'1.2-2'}} ₺</div>
              </div>
              <div>
                <span class="muted">Toplam Faiz:</span>
                <div class="bold text-danger">{{hesaplamaResult.ozet.toplamFaiz | number:'1.2-2'}} ₺</div>
              </div>
            </div>

            <!-- Sadece ürün seçiliyse başvuru butonu göster -->
            <button *ngIf="hesaplamaModu === 'urun' && selectedBankaUrunId" 
                    (click)="basvuruYap()" 
                    class="btn btn--success btn--block">
              Bu Hesaplama ile Başvuru Yap
            </button>
            
            <!-- Manuel hesaplama ise bilgi mesajı göster -->
            <div *ngIf="hesaplamaModu === 'manuel'" 
                 class="alert alert--warning mt-15">
              <strong>Not:</strong> Manuel faiz oranı ile yapılan hesaplamalar sadece bilgilendirme amaçlıdır. Başvuru yapmak için lütfen banka ürünlerinden birini seçin.
            </div>
          </div>
        </div>
      </div>

      <!-- Ödeme Planı -->
      <div *ngIf="hesaplamaResult?.plan && hesaplamaResult.plan.length > 0" 
           class="card">
        <h2 class="card__title">Ödeme Planı</h2>
        
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="th-left">Taksit No</th>
                <th class="th-left">Vade Tarihi</th>
                <th class="th-right">Taksit Tutarı</th>
                <th class="th-right">Ana Para</th>
                <th class="th-right">Faiz</th>
                <th class="th-right">Kalan Bakiye</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let taksit of hesaplamaResult.plan; let i = index" 
                  [class.row-alt]="i % 2 === 0">
                <td class="td">{{taksit.taksitNo}}</td>
                <td class="td">{{taksit.vadeTarihi}}</td>
                <td class="td td-right">{{taksit.taksitTutari | number:'1.2-2'}} ₺</td>
                <td class="td td-right">{{taksit.anaPara | number:'1.2-2'}} ₺</td>
                <td class="td td-right text-danger">{{taksit.faiz | number:'1.2-2'}} ₺</td>
                <td class="td td-right">{{taksit.kalanBakiye | number:'1.2-2'}} ₺</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Kredi Başvuru Tab -->
    <div *ngIf="activeTab === 'basvuru'" class="container container--narrow">
      <div class="basvuru-header">
        <h1 class="title">Kredi Başvuru</h1>
        <button *ngIf="isLoggedIn"
                (click)="togglePastApplications()"
                class="btn btn--outline btn--small">
          {{showPastApplications ? 'Yeni Başvuru Yap' : 'Geçmiş Başvurularım'}}
        </button>
      </div>

      <!-- Geçmiş Başvurular -->
      <div *ngIf="showPastApplications && isLoggedIn" class="card">
        <h2 class="card__title">Geçmiş Başvurularım</h2>

        <div *ngIf="pastApplications.length === 0" class="text-muted">
          Henüz başvuru yapmadınız.
        </div>

        <div *ngIf="pastApplications.length > 0" class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th class="th-left">Başvuru No</th>
                <th class="th-left">Banka</th>
                <th class="th-left">Ürün</th>
                <th class="th-right">Tutar</th>
                <th class="th-right">Vade</th>
                <th class="th-left">Tarih</th>
                <th class="th-left">Durum</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let app of pastApplications; let i = index"
                  [class.row-alt]="i % 2 === 0">
                <td class="td">#{{app.id}}</td>
                <td class="td">{{app.bankaAdi}}</td>
                <td class="td">{{app.urunAdi}}</td>
                <td class="td td-right">{{app.krediTutari | number:'1.0-0'}} ₺</td>
                <td class="td td-right">{{app.krediVadesi}} ay</td>
                <td class="td">{{app.basvuruTarihi | date:'dd.MM.yyyy HH:mm'}}</td>
                <td class="td">
                  <span class="badge badge--warning">Onay Bekleniyor</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Giriş yapmamış kullanıcı için uyarı -->
      <div *ngIf="!isLoggedIn && !showPastApplications" class="card">
        <div class="alert alert--warning">
          <strong>Dikkat:</strong> Başvuru yapmak için önce giriş yapmalısınız. 
          <button (click)="setActiveTab('auth')" class="btn btn--primary btn--small">Giriş Yap</button>
        </div>
      </div>

      <!-- Giriş yapmış kullanıcı için başvuru formu -->
      <div *ngIf="isLoggedIn && !showPastApplications" class="card card--lg">
        <div class="grid-2 gap-20">
          <!-- Kişisel Bilgiler -->
          <div class="form-group">
            <label class="label">Email</label>
            <input type="email"
                   [(ngModel)]="basvuru.email"
                   class="input"
                   placeholder="ornek@email.com"
                   readonly>
          </div>

          <div class="form-group">
            <label class="label">Ad Soyad</label>
            <input type="text"
                   [(ngModel)]="basvuru.adSoyad"
                   class="input"
                   placeholder="Adınız Soyadınız"
                   readonly>
          </div>

          <div class="form-group">
            <label class="label">TC Kimlik Numarası</label>
            <input type="text"
                   [(ngModel)]="basvuru.tcKimlikNo"
                   class="input"
                   placeholder="TC Kimlik Numaranız"
                   readonly>
          </div>

          <div class="form-group">
            <label class="label">Telefon</label>
            <input type="text"
                   [(ngModel)]="basvuru.telefon"
                   class="input"
                   placeholder="Telefon Numaranız"
                   readonly>
          </div>

          <!-- Banka Seçimi - Sadece üye bankalar -->
          <div class="form-group">
            <label class="label">Banka</label>
            <select [(ngModel)]="basvuruBankaId" 
                    (ngModelChange)="onBasvuruBankaChange()"
                    class="input">
              <option value="">Banka Seçiniz</option>
              <option *ngFor="let banka of getMemberBanks()" [value]="banka.id">{{banka.ad}}</option>
            </select>
            <div *ngIf="getMemberBanks().length === 0" class="text-danger text-sm mt-5">
              Başvuru yapmak için önce banka müşterisi olmalısınız.
              <button (click)="setActiveTab('banka-uyelik')" class="btn btn--small btn--outline">Banka Müşterisi Ol</button>
            </div>
          </div>

          <!-- Ürün Seçimi -->
          <div class="form-group">
            <label class="label">Kredi Ürünü</label>
            <select [(ngModel)]="basvuru.bankaUrunId"
                    [disabled]="!basvuruBankaId"
                    class="input"
                    [class.input--disabled]="!basvuruBankaId">
              <option value="">Ürün Seçiniz</option>
              <option *ngFor="let urun of basvuruBankaUrunleri" [value]="urun.id">
                {{urun.urunAdi}} - Faiz: %{{urun.faizOrani}}
              </option>
            </select>
          </div>

          <!-- Kredi Tutarı -->
          <div class="form-group">
            <label class="label">Kredi Tutarı (₺)</label>
            <input type="number" 
                   [(ngModel)]="basvuru.krediTutari"
                   class="input"
                   placeholder="100000">
            <div *ngIf="getSelectedBasvuruUrun()" class="hint">
              Min: {{getSelectedBasvuruUrun()!.minTutar | number:'1.0-0'}} ₺ - 
              Max: {{getSelectedBasvuruUrun()!.maxTutar | number:'1.0-0'}} ₺
            </div>
          </div>

          <!-- Vade -->
          <div class="form-group">
            <label class="label">Vade (Ay)</label>
            <input type="number" 
                   [(ngModel)]="basvuru.krediVadesi"
                   class="input"
                   placeholder="36">
            <div *ngIf="getSelectedBasvuruUrun()" class="hint">
              Min: {{getSelectedBasvuruUrun()!.minVade}} ay - 
              Max: {{getSelectedBasvuruUrun()!.maxVade}} ay
            </div>
          </div>
        </div>

          <!-- Gelir -->
          <div class="form-group">
            <label class="label">Aylık Gelir (₺)</label>
            <input type="number" 
                   [(ngModel)]="basvuru.gelir"
                   class="input"
                   placeholder="15000">
            <div class="hint">
              Aylık gelir bilginizi giriniz
            </div>
          </div>
        

        <!-- Seçilen ürün özeti -->
        <div *ngIf="getSelectedBasvuruUrun()" 
             class="box mt-20">
          <h4 class="subtitle">Seçilen Ürün Detayları</h4>
          <div class="grid-2 text-sm">
            <div>
              <span class="muted">Banka:</span>
              <strong>{{getSelectedBasvuruUrun()!.bankaAdi}}</strong>
            </div>
            <div>
              <span class="muted">Ürün:</span>
              <strong>{{getSelectedBasvuruUrun()!.urunAdi}}</strong>
            </div>
            <div>
              <span class="muted">Faiz Oranı:</span>
              <strong>%{{getSelectedBasvuruUrun()!.faizOrani}}</strong>
            </div>
          </div>
        </div>

        <button (click)="basvuruyuGonder()" 
                [disabled]="!canSubmitBasvuru()"
                class="btn btn--primary btn--block mt-20"
                [class.btn--disabled]="!canSubmitBasvuru()">
          Başvuru Gönder
        </button>
      </div>

      <!-- Başvuru Sonucu -->
      <div *ngIf="basvuruResult" class="card mt-20">
        <h3 class="text-success mb-15">✓ Başvuru Başarılı!</h3>
        <p>{{basvuruResult.message}}</p>
        <p><strong>Başvuru No:</strong> #{{basvuruResult.basvuruId}}</p>
        
        <div class="alert alert--success mt-15">
          <strong>Sonraki Adımlar:</strong>
          <ul class="list">
            <li>Başvurunuz bankaya iletilmiştir</li>
            <li>En kısa sürede size dönüş yapılacaktır</li>
            <li>Belirtilen email adresine bilgilendirme gönderilecektir</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Auth Tab -->
    <div *ngIf="activeTab === 'auth'" class="container container--narrow">
      <h1 class="title">Giriş / Kayıt</h1>
      
      <div class="card card--lg">
        <!-- Auth Mode Toggle -->
        <div class="auth-toggle">
          <button (click)="setAuthMode('login')" 
                  class="btn"
                  [class.btn--primary]="authMode === 'login'"
                  [class.btn--outline]="authMode !== 'login'">
            Giriş Yap
          </button>
          <button (click)="setAuthMode('signup')" 
                  class="btn"
                  [class.btn--primary]="authMode === 'signup'"
                  [class.btn--outline]="authMode !== 'signup'">
            Kayıt Ol
          </button>
        </div>

        <!-- Login Form -->
        <div *ngIf="authMode === 'login'" class="auth-form">
          <h2 class="subtitle">Giriş Yap</h2>
          
          <div class="form-group">
            <label class="label">Email</label>
            <input type="email" 
                   [(ngModel)]="authForm.email"
                   class="input"
                   placeholder="ornek@email.com">
          </div>

          <div class="form-group">
            <label class="label">Şifre</label>
            <input type="password" 
                   [(ngModel)]="authForm.sifre"
                   class="input"
                   placeholder="Şifrenizi girin">
          </div>

          <button (click)="submitAuth()" 
                  [disabled]="!canSubmitAuth()"
                  class="btn btn--primary btn--block"
                  [class.btn--disabled]="!canSubmitAuth()">
            Giriş Yap
          </button>
        </div>

        <!-- Signup Form -->
        <div *ngIf="authMode === 'signup'" class="auth-form">
          <h2 class="subtitle">Kayıt Ol</h2>
          
          <div class="form-group">
            <label class="label">Email</label>
            <input type="email" 
                   [(ngModel)]="authForm.email"
                   class="input"
                   placeholder="ornek@email.com">
          </div>

          <div class="form-group">
            <label class="label">Ad Soyad</label>
            <input type="text" 
                   [(ngModel)]="authForm.adSoyad"
                   class="input"
                   placeholder="Adınız Soyadınız">
          </div>

          <div class="form-group">
            <label class="label">Telefon</label>
            <input type="text" 
                   [(ngModel)]="authForm.telefon"
                   class="input"
                   placeholder="Telefon Numaranız">
          </div>

          <div class="form-group">
            <label class="label">Doğum Tarihi</label>
            <input type="date" 
                   [(ngModel)]="authForm.dogumTarihi"
                   class="input"
                   placeholder="Doğum Tarihiniz">
          </div>

          <div class="form-group">
            <label class="label">TC Kimlik No</label>
            <input type="text" 
                   [(ngModel)]="authForm.tcKimlikNo"
                   class="input"
                   placeholder="TC Kimlik Numaranız">
          </div>

          <div class="form-group">
            <label class="label">Şifre</label>
            <input type="password" 
                   [(ngModel)]="authForm.sifre"
                   class="input"
                   placeholder="En az 6 karakter">
          </div>

          <div class="form-group">
            <label class="label">Şifre Tekrar</label>
            <input type="password" 
                   [(ngModel)]="authForm.sifreTekrar"
                   class="input"
                   placeholder="Şifrenizi tekrar girin">
            <div *ngIf="authForm.sifre && authForm.sifreTekrar && authForm.sifre !== authForm.sifreTekrar" 
                 class="text-danger text-sm mt-5">
              Şifreler eşleşmiyor
            </div>
          </div>

          <button (click)="submitAuth()" 
                  [disabled]="!canSubmitAuth()"
                  class="btn btn--primary btn--block"
                  [class.btn--disabled]="!canSubmitAuth()">
            Kayıt Ol
          </button>
        </div>
      </div>
    </div>

    <!-- Banka Üyelik Tab -->
    <div *ngIf="activeTab === 'banka-uyelik'" class="container">
      <h1 class="title">Banka Müşterisi Ol</h1>
      
      <div class="grid-2 gap-20">
        <!-- Mevcut Bankalar -->
        <div class="card">
          <h2 class="card__title">Üye Olduğum Bankalar</h2>
          
          <div *ngIf="myBanks.length === 0" class="text-muted">
            Henüz hiçbir bankaya üye değilsiniz.
          </div>
          
          <div *ngFor="let bank of myBanks" class="bank-item">
  <img [src]="resolveBankLogo(bank)" alt="{{bank.ad}} logo" class="bank-item__logo">
  <div class="bank-item__info">
    <h4 class="bank-item__name">{{bank.ad}}</h4>
    <p class="bank-item__date text-sm text-muted">
      Üyelik: {{bank.uyelikTarihi | date:'dd.MM.yyyy'}}
    </p>
  </div>
  <button (click)="leaveBank(bank.id)" class="btn btn--small btn--danger">Ayrıl</button>
</div>
        </div>
      
        <!-- Mevcut Bankalar -->
        <div class="card">
          <h2 class="card__title">Üye Olabileceğim Bankalar</h2>
          
          <div *ngIf="availableBanks.length === 0" class="text-muted">
            Tüm bankalara zaten üyesiniz.
          </div>
          
          <div *ngFor="let bank of availableBanks" class="bank-item">
  <img [src]="resolveBankLogo(bank)" alt="{{bank.ad}} logo" class="bank-item__logo">
  <div class="bank-item__info">
    <h4 class="bank-item__name">{{bank.ad}}</h4>
  </div>
  <button (click)="joinBank(bank.id)" class="btn btn--small btn--success">Üye Ol</button>
</div>
        </div>
      </div>
    </div>
  </div>
</div>